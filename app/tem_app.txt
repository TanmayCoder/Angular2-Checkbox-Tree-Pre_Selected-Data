///<reference path="./../typings/globals/core-js/index.d.ts"/>
import { Component, Input, OnInit, EventEmitter, OnDestroy  } from '@angular/core';
import{TreeNode} from 'primeng/primeng';
import{NodeService} from './nodeService';
@Component({
    selector: 'my-app',
    templateUrl: 'app/app.component.html'
})
export class AppComponent  implements OnInit{
    first = { content: 'Angular 2 Start' };
    color = 'green';
    data: any[] = [];
    hash = {};

    selectedNodes: any=[]

    constructor(private nodeService:NodeService){
       this.nodeService.getMenus().then(files => this.filesTree4 = files);
         this.data =
        [
            {
                "label": "Documents",
                "children": [{
                        "label": "Work",
                        "children": [{"label": "Expenses.doc", "children":[]}, {"label": "Resume.doc", "children":[]}]
                    },
                    {
                        "selected": false,
                        "label": "Home",
                        "children": [{"label": "Invoices.txt", "children":[]}]
                    }]
            },
            {
                "label": "Pictures",
                "children": [
                    {"label": "barcelona.jpg", "children":[]},
                    {"label": "logo.jpg", "children":[]},
                    {"label": "primeui.png", "children":[]}]
            },
            {
                "label": "Movies",
                "children": [{
                        "label": "Al Pacino",
                        "children": [{"label": "Scarface", "data": "Scarface Movie", "children":[]}, {"label": "Serpico", "data": "Serpico Movie", "children":[]}]
                    },
                    {
                        "label": "Robert De Niro",
                        "children": [{"label": "Goodfellas", "children":[]}, {"label": "Untouchables", "children":[]}]
                    }]
            }
        ]

        this.hash = this.buildDataHierarchy(this.data);
        
    }
  buildDataHierarchy(data: any[]): any {
        let id = 1;
        let hash = {};
        let setNodeID = (node : any, parentId: number) => {
            hash[id] = node;
            node['selected'] = false;
            node['nodeId'] = id;
            node['parentNodeId'] = parentId;
            if (node.children.length){
                const parentId = id;
                node.children.forEach(function(node: any){
                    id++;
                    setNodeID(node, parentId);
                });
            }
            id++;
        }
        data.forEach(function(node: any){
            setNodeID(node, 0);
        });
        return hash;
    }

    nodeSelected(toggleNode: any) {
        // select / unselect all children (recursive)
        let toggleChildren = (node: any) => {
            node.children.forEach(function (child: any) {
                child.selected = node.selected;
                if (child.children.length) {
                    toggleChildren(child);
                }
            });
        }
        toggleChildren(toggleNode);

        //update parent if needed (recursive)
        let updateParent = (node: any) => {debugger;
            if (node.parentNodeId != 0) {
                const parentNode = this.hash[node.parentNodeId];
                const siblings = parentNode.children;
                parentNode.partialSelection = false;
                let equalSiblings = true;
                siblings.forEach(function(sibling: any){
                    if (sibling.selected !== node.selected){
                        equalSiblings = false;
                    }
                });
                if (equalSiblings){
                    parentNode.selected = node.selected;
                    if (parentNode.parentNodeId != 0){
                        updateParent(parentNode);
                    }
                }else{
                    parentNode.partialSelection = true;
                }
            }
        }
        updateParent(toggleNode);
        this.updateSelected();
    }

    updateSelected(){
        this.selectedNodes = [];
        for (let node in this.hash) {
            if (this.hash[node].selected) {
                let currentNode = this.hash[node];
                let nodeLabel = currentNode['label'];
                while (currentNode.parentNodeId !==0){
                    currentNode = this.hash[currentNode.parentNodeId];
                    nodeLabel =  nodeLabel;
                }
                this.selectedNodes.push(nodeLabel);
            }
        }
    }

    ngOnInit() {
       
    }

    ngOnDestroy() {
       // jQuery('#' + this.datepickerOptions.controlId).datepicker('destroy');
    }
}